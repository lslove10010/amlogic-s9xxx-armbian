name: Build Armbian for X96 Max+ (S905X3)

on:
  workflow_dispatch:
    inputs:
      armbian_board:
        description: 'Board'
        required: true
        default: 's905x3-x96max+'
      armbian_kernel:
        description: 'Kernel'
        required: true
        default: '6.6.y'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android

      - name: Download official Armbian trunk (Odroid-N2 base for S905X3)
        id: download
        run: |
          mkdir -p build/output/images
          cd build/output/images
          SITE="https://dl.armbian.com/odroidn2/"
          FILE=$(curl -s "$SITE" | grep -oE 'Armbian_.*-trunk.*_current_.*\.img\.xz' | head -n 1)
          if [[ -z "$FILE" ]]; then
            SITE="https://armbian.tnahosting.net/dl/odroidn2/"
            FILE=$(curl -s "$SITE" | grep -oE 'Armbian_.*-trunk.*_current_.*\.img\.xz' | head -n 1)
          fi
          if [[ -n "$FILE" ]]; then
            echo "正在下载: $SITE/$FILE"
            wget "$SITE/$FILE"
            echo "BASE_IMAGE=$FILE" >> $GITHUB_ENV
            echo "download_success=true" >> $GITHUB_OUTPUT
          else
            echo "错误：未找到 Armbian trunk 镜像"
            exit 1
          fi

      - name: Build Armbian
        if: steps.download.outputs.download_success == 'true'
        uses: ophub/amlogic-s9xxx-armbian@main
        with:
          build_target: armbian
          armbian_path: build/output/images/${{ env.BASE_IMAGE }}
          armbian_board: ${{ inputs.armbian_board }}
          armbian_kernel: ${{ inputs.armbian_kernel }}
          armbian_size: 5000
          armbian_fstype: ext4
          compress: xz
          auto_kernel: true

      - name: Upload to Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Armbian-X96MaxPlus-${{ inputs.armbian_kernel }}
          path: build/output/images/*.img.xz
          retention-days: 30

      # 新增：上传到 GitHub Releases
      - name: Create GitHub Release
        if: success()
        uses: ncipollo/release-action@v1
        with:
          tag: x96max-plus-${{ inputs.armbian_kernel }}-${{ github.run_number }}
          name: X96 Max+ Armbian ${{ inputs.armbian_kernel }}
          body: |
            ### 设备信息
            - **板型**: `s905x3-x96max+`
            - **内核**: ${{ inputs.armbian_kernel }}
            - **基础镜像**: ${{ env.BASE_IMAGE }}
            
            ### 登录信息
            - 用户名: `root`
            - 密码: `1234`（首次登录强制修改）
            
            ### 安装命令
            ```bash
            armbian-install  # 安装到 eMMC
