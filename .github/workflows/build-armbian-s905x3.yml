name: Rebuild Armbian

on:
  workflow_dispatch:
    inputs:
      board:
        description: 'Board type (e.g., s905x3)'
        required: true
        default: 's905x3'
      kernel:
        description: 'Kernel version (e.g., 6.6.y)'
        required: true
        default: '6.6.y'

jobs:
  rebuild:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Armbian base image
        id: down
        run: |
          # 下载 Armbian trunk 镜像：使用 Odroid-N2（S905X3 兼容），可替换站点
          armbian_site="https://dl.armbian.com/odroidn2/"
          armbian_name="Armbian_.*-trunk.*_current_.*.img.xz"  # 调整为 trunk current 模式
          armbian_file=$(curl -s "${armbian_site}" | grep -oE "${armbian_name}" | head -n 1)
          if [[ -n "${armbian_file}" ]]; then
            armbian_url="${armbian_site}${armbian_file}"
            # 下载文件到本地路径
            wget -O build/output/images/base.img.xz "${armbian_url}"
            echo "ARMBIAN_PATH=build/output/images/base.img.xz" >> ${GITHUB_ENV}
          else
            echo "Invalid download path: [ ${armbian_site} ]. Check site for trunk files."
            exit 1
          fi

      - name: Generate build tag
        id: tag
        if: success()  # 仅在下载成功后执行
        run: |
          build_tag="Armbian_rebuild_$(date +%Y.%m.%d)"
          echo "build_tag=${build_tag}" >> $GITHUB_OUTPUT

      - name: Rebuild Armbian for Amlogic
        if: success()
        uses: ophub/amlogic-s9xxx-armbian@main
        with:
          build_target: armbian
          armbian_path: ${{ env.ARMBIAN_PATH }}  # 使用下载的文件路径
          armbian_board: ${{ inputs.board }}  # 如 s905x3
          armbian_kernel: ${{ inputs.kernel }}  # 如 6.6.y
          armbian_size: 5000  # 镜像大小 (MiB)
          armbian_fstype: ext4  # 文件系统
          auto_kernel: true  # 自动用最新内核版本

      - name: Upload Armbian image to Release
        if: success()  # 仅成功时上传
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.tag.outputs.build_tag }}
          artifacts: build/output/images/*.img.xz
          allowUpdates: true
          removeArtifacts: false
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ### Armbian Image Information
            - **Board**: ${{ inputs.board }}
            - **Kernel**: ${{ inputs.kernel }}
            - Default username: root
            - Default password: 1234
            - Install command: armbian-install

env:
  PACKAGED_OUTPUTPATH: build/output/images/
  PACKAGED_STATUS: success
